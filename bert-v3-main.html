<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BERT v3.0 - Plataforma de An√°lisis Estad√≠stico</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
            padding: 24px;
            background: #21262d;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .header h1 {
            color: #f0f6fc;
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .header p {
            color: #8b949e;
            font-size: 16px;
        }
        .modules {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        .module {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 24px;
        }
        .module h3 {
            color: #f0f6fc;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .drop-zone {
            border: 2px dashed #30363d;
            border-radius: 6px;
            padding: 48px 24px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #0d1117;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.05);
        }
        .drop-zone.dragover {
            border-style: solid;
        }
        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: #8b949e;
        }
        .drop-zone-text {
            color: #c9d1d9;
            font-size: 16px;
            margin-bottom: 8px;
        }
        .drop-zone-subtext {
            color: #8b949e;
            font-size: 14px;
        }
        .file-input {
            display: none;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            background: #0d1117;
            border-radius: 6px;
            overflow: hidden;
        }
        .preview-table th, .preview-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #30363d;
            font-size: 12px;
        }
        .preview-table th {
            background: #21262d;
            color: #f0f6fc;
            font-weight: 600;
        }
        .preview-table td {
            color: #c9d1d9;
        }
        .status {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 16px 0;
            font-size: 14px;
        }
        .status.success {
            background: rgba(46, 160, 67, 0.15);
            border: 1px solid rgba(46, 160, 67, 0.4);
            color: #3fb950;
        }
        .status.error {
            background: rgba(248, 81, 73, 0.15);
            border: 1px solid rgba(248, 81, 73, 0.4);
            color: #f85149;
        }
        .status.info {
            background: rgba(88, 166, 255, 0.15);
            border: 1px solid rgba(88, 166, 255, 0.4);
            color: #58a6ff;
        }
        @media (max-width: 768px) {
            .modules {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ BERT v3.0</h1>
            <p>Plataforma Web para An√°lisis Estad√≠stico con R</p>
        </div>

        <div class="modules">
            <div class="module">
                <h3>üìÅ Carga de Datos</h3>
                <div class="drop-zone" onclick="document.getElementById('dataFile').click()">
                    <div class="drop-zone-icon">üìä</div>
                    <div class="drop-zone-text">Arrastra archivos aqu√≠ o haz clic para seleccionar</div>
                    <div class="drop-zone-subtext">Soporta CSV, TXT, XLSX (m√°x. 50MB)</div>
                </div>
                <input type="file" id="dataFile" class="file-input" accept=".csv,.txt,.xlsx,.xls" multiple>
                <div id="dataStatus"></div>
                <div id="dataPreview"></div>
            </div>

            <div class="module">
                <h3>üìù Scripts R</h3>
                <div class="drop-zone" onclick="document.getElementById('scriptFile').click()">
                    <div class="drop-zone-icon">üìÑ</div>
                    <div class="drop-zone-text">Arrastra scripts R aqu√≠ o haz clic</div>
                    <div class="drop-zone-subtext">Archivos .R √∫nicamente</div>
                </div>
                <input type="file" id="scriptFile" class="file-input" accept=".R" multiple>
                <div id="scriptStatus"></div>
                <div id="scriptPreview"></div>
            </div>
        </div>

        <div class="module">
            <h3>‚ö° Ejecuci√≥n y Resultados</h3>
            <div id="executionArea">
                <div id="executionControls" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #f0f6fc; font-weight: 600;">Funci√≥n a Ejecutar:</label>
                            <select id="functionSelect" style="width: 100%; padding: 8px 12px; background: #21262d; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                                <option value="">Seleccionar funci√≥n...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #f0f6fc; font-weight: 600;">Par√°metros (opcional):</label>
                            <input type="text" id="parametersInput" placeholder="ej: col1, col2" style="width: 100%; padding: 8px 12px; background: #21262d; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9;">
                        </div>
                    </div>
                    <div style="text-align: center; margin-bottom: 24px;">
                        <button id="executeBtn" onclick="executeAnalysis()" style="background: #238636; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">Ejecutar An√°lisis</button>
                    </div>
                </div>
                <div id="executionStatus" style="text-align: center; padding: 48px; color: #8b949e;">
                    Carga datos y scripts para comenzar el an√°lisis
                </div>
                <div id="resultsArea"></div>
            </div>
        </div>
    </div>

    <script>
        // Drag and Drop para datos
        setupDropZone('dataFile', handleDataFiles);
        // Drag and Drop para scripts
        setupDropZone('scriptFile', handleScriptFiles);

        function setupDropZone(inputId, handler) {
            const input = document.getElementById(inputId);
            const dropZone = input.parentElement.querySelector('.drop-zone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                input.files = files;
                handler(files);
            }, false);

            input.addEventListener('change', (e) => handler(e.target.files));
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        async function handleDataFiles(files) {
            const statusDiv = document.getElementById('dataStatus');
            const previewDiv = document.getElementById('dataPreview');
            
            if (files.length === 0) return;
            
            statusDiv.innerHTML = '<div class="status info">Procesando archivos...</div>';
            
            try {
                for (let file of files) {
                    await processDataFile(file, previewDiv);
                }
                statusDiv.innerHTML = `<div class="status success">‚úÖ ${files.length} archivo(s) cargado(s) exitosamente</div>`;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function handleScriptFiles(files) {
            const statusDiv = document.getElementById('scriptStatus');
            const previewDiv = document.getElementById('scriptPreview');
            
            if (files.length === 0) return;
            
            statusDiv.innerHTML = '<div class="status info">Analizando scripts R...</div>';
            
            try {
                for (let file of files) {
                    await processScriptFile(file, previewDiv);
                }
                statusDiv.innerHTML = `<div class="status success">‚úÖ ${files.length} script(s) analizado(s) exitosamente</div>`;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function processDataFile(file, previewDiv) {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch('/api/upload-data', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayDataPreview(result, previewDiv);
                // Almacenar sessionId para uso posterior
                window.currentDataSession = result.sessionId;
                updateExecutionControls();
            } else {
                throw new Error(result.error);
            }
        }

        async function processScriptFile(file, previewDiv) {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch('/api/upload-script', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayScriptPreview(result, previewDiv);
            } else {
                throw new Error(result.error);
            }
        }

        function displayDataPreview(result, container) {
            const { preview, total, fileType, fileName } = result;
            
            let html = `<div style="margin: 16px 0; font-size: 14px; color: #8b949e;">
                ${fileName} (${fileType.toUpperCase()}) - ${total} registros
            </div>`;
            
            if (preview && preview.length > 0) {
                html += '<table class="preview-table">';
                
                // Headers
                html += '<thead><tr>';
                for (let i = 0; i < Math.min(preview[0].length, 10); i++) {
                    html += `<th>Col ${i + 1}</th>`;
                }
                html += '</tr></thead>';
                
                // Data rows (max 10)
                html += '<tbody>';
                for (let i = 0; i < Math.min(preview.length, 10); i++) {
                    html += '<tr>';
                    for (let j = 0; j < Math.min(preview[i].length, 10); j++) {
                        html += `<td>${preview[i][j] || ''}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table>';
            }
            
            container.innerHTML = html;
        }

        function displayScriptPreview(result, container) {
            const { functions, libraries, fileName, sessionId } = result;
            
            let html = `<div style="margin: 16px 0; font-size: 14px; color: #8b949e;">
                ${fileName}
            </div>`;
            
            if (functions && functions.length > 0) {
                html += `<div style="margin: 8px 0;"><strong>Funciones:</strong> ${functions.join(', ')}</div>`;
                
                // RF3.1: Llenar dropdown con funciones detectadas
                const functionSelect = document.getElementById('functionSelect');
                functionSelect.innerHTML = '<option value="">Seleccionar funci√≥n...</option>';
                functions.forEach(func => {
                    const option = document.createElement('option');
                    option.value = func;
                    option.textContent = func;
                    functionSelect.appendChild(option);
                });
                
                // Almacenar sessionId para uso posterior
                window.currentScriptSession = sessionId;
            }
            
            if (libraries && libraries.length > 0) {
                html += `<div style="margin: 8px 0;"><strong>Librer√≠as:</strong> ${libraries.join(', ')}</div>`;
            }
            
            container.innerHTML = html;
            
            // Mostrar controles de ejecuci√≥n si hay datos y scripts
            updateExecutionControls();
        }
        
        // RF3.1: Actualizar controles de ejecuci√≥n
        function updateExecutionControls() {
            const hasData = window.currentDataSession;
            const hasScript = window.currentScriptSession;
            const controls = document.getElementById('executionControls');
            const status = document.getElementById('executionStatus');
            
            if (hasData && hasScript) {
                controls.style.display = 'block';
                status.innerHTML = '<div style="color: #3fb950; font-size: 14px;">‚úÖ Listo para ejecutar an√°lisis</div>';
            } else {
                controls.style.display = 'none';
                const missing = [];
                if (!hasData) missing.push('datos');
                if (!hasScript) missing.push('script R');
                status.innerHTML = `<div style="color: #f85149; font-size: 14px;">‚ùå Falta cargar: ${missing.join(' y ')}</div>`;
            }
        }
        
        // RF3.2: Ejecutar an√°lisis as√≠ncrono
        async function executeAnalysis() {
            const functionName = document.getElementById('functionSelect').value;
            const parameters = document.getElementById('parametersInput').value;
            
            if (!functionName) {
                alert('Selecciona una funci√≥n para ejecutar');
                return;
            }
            
            const executeBtn = document.getElementById('executeBtn');
            const resultsArea = document.getElementById('resultsArea');
            
            try {
                executeBtn.disabled = true;
                executeBtn.textContent = 'Ejecutando...';
                
                // Iniciar an√°lisis
                const response = await fetch('/api/run-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dataSessionId: window.currentDataSession,
                        scriptSessionId: window.currentScriptSession,
                        functionName: functionName,
                        parameters: parameters
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // RF3.2: Polling del estado del job
                    pollJobStatus(result.jobId, resultsArea);
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                resultsArea.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                executeBtn.disabled = false;
                executeBtn.textContent = 'Ejecutar An√°lisis';
            }
        }
        
        // RF3.2: Polling del estado del job
        async function pollJobStatus(jobId, container) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/status/${jobId}`);
                    const status = await response.json();
                    
                    if (status.success) {
                        updateJobStatus(status, container);
                        
                        if (status.status === 'completed' || status.status === 'failed') {
                            clearInterval(pollInterval);
                            document.getElementById('executeBtn').disabled = false;
                            document.getElementById('executeBtn').textContent = 'Ejecutar An√°lisis';
                        }
                    }
                } catch (error) {
                    clearInterval(pollInterval);
                    container.innerHTML = `<div class="status error">‚ùå Error consultando estado: ${error.message}</div>`;
                }
            }, 1000);
        }
        
        // Actualizar estado del job en la UI
        function updateJobStatus(status, container) {
            let html = `<div style="margin: 16px 0;">`;
            
            // Barra de progreso
            html += `<div style="background: #21262d; border-radius: 6px; overflow: hidden; margin-bottom: 16px;">`;
            html += `<div style="background: #238636; height: 8px; width: ${status.progress}%; transition: width 0.3s ease;"></div>`;
            html += `</div>`;
            
            // Estado actual
            const statusText = {
                'queued': 'üï∞Ô∏è En cola',
                'running': '‚ö° Ejecutando',
                'completed': '‚úÖ Completado',
                'failed': '‚ùå Error'
            };
            
            html += `<div style="font-size: 14px; color: #c9d1d9; margin-bottom: 16px;">`;
            html += `Estado: ${statusText[status.status]} (${status.progress}%)`;
            html += `</div>`;
            
            // Resultado
            if (status.status === 'completed' && status.result) {
                html += displayAnalysisResult(status.result);
            } else if (status.status === 'failed') {
                html += `<div class="status error">‚ùå ${status.error}</div>`;
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }
        
        // RF3.3 & RF3.4: Mostrar resultados (texto, STARGAZER, gr√°ficos Plotly)
        function displayAnalysisResult(result) {
            let html = '<div style="margin-top: 24px;">';
            
            if (result.type === 'plotly' && result.plotlyData) {
                // RF3.4: Gr√°fico Plotly interactivo
                const plotId = 'plotly-' + Date.now();
                html += '<h4 style="color: #f0f6fc; margin-bottom: 16px;">üìâ Gr√°fico Interactivo (Plotly)</h4>';
                html += `<div id="${plotId}" style="width: 100%; height: 500px; background: #0d1117; border-radius: 6px;"></div>`;
                
                // Renderizar Plotly despu√©s de insertar HTML
                setTimeout(() => {
                    const plotlyConfig = {
                        displayModeBar: true,
                        displaylogo: false,
                        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                        responsive: true
                    };
                    
                    const layout = {
                        ...result.plotlyData.layout,
                        paper_bgcolor: '#0d1117',
                        plot_bgcolor: '#161b22',
                        font: { color: '#c9d1d9' },
                        xaxis: { ...result.plotlyData.layout?.xaxis, gridcolor: '#30363d' },
                        yaxis: { ...result.plotlyData.layout?.yaxis, gridcolor: '#30363d' }
                    };
                    
                    Plotly.newPlot(plotId, result.plotlyData.data, layout, plotlyConfig);
                }, 100);
                
            } else if (result.type === 'stargazer' && result.html) {
                // RF3.3: Tabla STARGAZER
                html += '<h4 style="color: #f0f6fc; margin-bottom: 16px;">üìà Resultado (Stargazer)</h4>';
                html += `<div style="background: #0d1117; padding: 16px; border-radius: 6px; overflow-x: auto;">${result.html}</div>`;
            } else if (result.type === 'plot' && result.plotFile) {
                // Gr√°fico est√°tico (fallback)
                html += '<h4 style="color: #f0f6fc; margin-bottom: 16px;">üìâ Gr√°fico</h4>';
                html += `<div style="text-align: center;"><img src="/${result.plotFile}" style="max-width: 100%; border-radius: 6px;"></div>`;
            } else {
                // RF3.3: Salida de texto
                html += '<h4 style="color: #f0f6fc; margin-bottom: 16px;">üìù Resultado</h4>';
                html += `<pre style="background: #0d1117; padding: 16px; border-radius: 6px; overflow-x: auto; color: #c9d1d9; font-size: 12px; line-height: 1.4;">${result.output}</pre>`;
            }
            
            html += '</div>';
            return html;
        }
    </script>
</body>
</html>